name: Deploy to IPFS via Pinata

on:
  push:
    branches:
      - main

jobs:
  pinata-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Pinata SDK
        run: npm install @pinata/sdk

      - name: Pin site folder to IPFS via Pinata SDK
    env:
      PINATA_API_KEY: ${{ secrets.PINATA_API_KEY }}
      PINATA_API_SECRET: ${{ secrets.PINATA_API_SECRET }}
    run: |
      node << 'EOF'
      import PinataSDK from '@pinata/sdk';
      import path from 'path';

      (async () => {
        try {
          const pinata = new PinataSDK(
            process.env.PINATA_API_KEY,
            process.env.PINATA_API_SECRET
          );
          const sitePath = path.resolve(process.cwd(), 'site');
          const result = await pinata.pinFromFS(sitePath, {
            pinataMetadata: { name: 'decentralized-site' }
          });
          console.log('Pinned CID:', result.IpfsHash);
        } catch (err) {
          console.error('Pinata error:', err);
          process.exit(1);
        }
      })();
      EOF
